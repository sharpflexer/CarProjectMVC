<body>
    <div class="login">
        <h1>Login to Web App</h1>
        <form id="submitForm" method="post" enctype="multipart/form-data" asp-controller="Read" asp-action="Index" h>
            <p><input id="username" type="text" name="username" value="" placeholder="Username" required></p>
            <p><input id="password" type="password" name="password" value="" placeholder="Password" required></p>
            <p class="remember_me">
                <label>
                    <input type="checkbox" name="remember_me" id="remember_me">
                    Remember me on this computer
                </label>
            </p>
            <p id="submitLogin"class="submit"><input type="submit" name="commit" value="Login"></p>
            <hr />
            @ViewBag.username
        </form>
    </div>
</body>
<script>
    var tokenKey = "accessToken";
    // при нажатии на кнопку отправки формы идет запрос к /login для получения токена
    document.getElementById("submitLogin").addEventListener("click", async e => {
        e.preventDefault();
        // отправляет запрос и получаем ответ

        const formData = new FormData();
        formData.append("username", document.getElementById("username").value);
        formData.append("password", document.getElementById("password").value);


        const response = await fetch("/Login/Token", {
            method: "POST",
            headers: { "Accept": "application/json" },
            body: formData
        });
        const data = await response.json();

        console.log(response);
        console.log(data);
        // если запрос прошел нормально
        if (response.ok === true) {
            // получаем данные

            // сохраняем в хранилище sessionStorage токен доступа
            sessionStorage.setItem(tokenKey, data);
            console.log(tokenKey);
            console.log(data);

            const token = sessionStorage.getItem(tokenKey);
           // const redirectUrl = "https://localhost:7020/Login/RedirectToRead";
            createCookie('Authorization', 'Bearer ' + token);
            window.location.href = "/Read/Index";
            //     console.log(token);
            //     const headers = {
            //         "Accept": "application/json",
            //         "Authorization": "Bearer " + token
            //        };

            //     const page = await fetch(redirectUrl, {
            //     method: "GET",
            //     headers: headers,
            //     })
            //     .then(function (html) {
            //         // Initialize the DOM parser
            //         var parser = new DOMParser();

            //         // Parse the text
            //         var doc = parser.parseFromString(html, "text/html");

            //         var docArticle = doc.querySelector('article').innerHTML;

            //         console.log(doc);
            //     })

            // }

        }

        function createCookie(name, value, days) {
            var expires;
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toGMTString();
            }
            else {
                expires = "";
            }
            document.cookie = name + "=" + value + expires + "; path=/";
        }

        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) {
                        c_end = document.cookie.length;
                    }
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }
    });
</script>
